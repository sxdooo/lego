# ====== 1. 构建阶段 ======
FROM node:22-alpine AS builder

# 安装 pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /lego

# 1.1 复制包管理文件（优先利用缓存）
COPY package.json pnpm-lock.yaml ./
COPY packages/product/package.json ./packages/product/

# 1.2 安装依赖（整个 monorepo）
RUN pnpm install --frozen-lockfile
RUN pnpm install --filter product

# 1.3 复制源码 & 构建
COPY . .
RUN pnpm --filter product build      # 确保 packages/product/package.json 里有 "scripts": { "build": "..." }

# ====== 2. 运行阶段 ======
FROM nginx:alpine

# 2.1 把构建产物扔进 nginx 默认根目录
COPY --from=builder /lego/packages/product/dist /usr/share/nginx/html

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]